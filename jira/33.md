---
Generated: 2025-01-27 21:00:00
Ticket Number: 33
---

# FBC-33: Enhance Revenus page - Expandable rows, shipping costs, and indirect costs

## Type

Feature

## Priority

High

## Story Points

13

## Labels

`feature`, `revenue`, `financial`, `dashboard`, `domain`, `usecases`, `presentation`, `database`

## Git Branch

`feat/fbc-33-revenus-advanced-features`

## Description

Enhance the Revenus page with advanced features:

1. **Expandable rows**: Revenue breakdown by product type and individual products
2. **Shipping costs**: Monthly shipping cost input (manual entry, not per-sale)
3. **Indirect costs**: Editable indirect cost lines (2-3 predefined lines related to sales)
4. **Net result calculation**: Gross margin - indirect costs = net result

This builds on the MVP (FBC-32) to provide a complete financial overview with detailed breakdowns and additional cost tracking.

## User Story

As a business owner, I want to see detailed revenue breakdowns by product and track all costs (shipping, indirect) so that I can understand profitability at a granular level and make data-driven decisions.

## Acceptance Criteria

1. **Expandable revenue rows**:
   - Add expandable row for "CA par type de produit"
   - Clicking expands to show revenue breakdown by `ProductType` (SAC_BANANE, POCHETTE_ORDINATEUR, etc.)
   - Add expandable row for "CA par produit"
   - Clicking expands to show revenue breakdown by individual products (product name + coloris)
   - Expansion state is managed (open/closed)
   - Create usecases: `computeRevenueByProductType` and `computeRevenueByProduct`
   - Create hooks: `useRevenueByProductType` and `useRevenueByProduct`

2. **Shipping costs**:
   - Add "Coût d'expédition" row in costs section
   - Create database table `monthly_costs` with fields: `id`, `month` (YYYY-MM), `shipping_cost` (NUMERIC), `created_at`, `updated_at`
   - Create domain type `MonthlyCost` in `core/domain/cost.ts`
   - Create repository interface `CostRepository` in `core/ports/costRepository.ts`
   - Implement `costRepositorySupabase` in `infrastructure/supabase/`
   - Create usecases: `getMonthlyShippingCost`, `createOrUpdateMonthlyShippingCost`
   - Add input field in Revenus page to enter/edit shipping cost for selected month
   - Shipping cost is saved per month (not per sale)
   - Display shipping cost in revenue table for selected period

3. **Indirect costs**:
   - Add "Coûts indirects" section in revenue table
   - Create 2-3 predefined indirect cost lines (e.g., "Marketing", "Frais généraux")
   - Store indirect costs in `monthly_costs` table: `marketing_cost`, `overhead_cost` (or flexible structure)
   - Allow editing indirect costs per month (similar to shipping cost)
   - Display indirect costs in revenue table
   - Calculate total indirect costs

4. **Net result calculation**:
   - Add "Résultat net" row: Gross margin - Total indirect costs
   - Calculate net margin rate: (Net result / Revenue) * 100
   - Display both net result amount and rate

5. **Revenue domain types updates**:
   - Update `RevenueData` type to include:
     - `costs.shipping` (number)
     - `indirectCosts` object with predefined lines
     - `netResult` (number)
     - `netMarginRate` (number)
   - Create `RevenueByProductType` and `RevenueByProduct` types

6. **UI/UX improvements**:
   - Expandable rows use proper icons (chevron down/up)
   - Smooth expand/collapse animation
   - Loading states for expandable data
   - Error handling for cost updates
   - Success feedback when costs are saved

## Technical Considerations

### Architecture Layers Impacted

-   **Domain Layer** (`core/domain/`):
    -   Create `cost.ts` with `MonthlyCost` type
    -   Update `revenue.ts` with new types: `RevenueByProductType`, `RevenueByProduct`
    -   Update `RevenueData` to include shipping and indirect costs

-   **Ports Layer** (`core/ports/costRepository.ts`):
    -   Create `CostRepository` interface with methods:
        -   `getMonthlyCost(month: string): Promise<MonthlyCost | null>`
        -   `createOrUpdateMonthlyCost(cost: MonthlyCost): Promise<MonthlyCost>`

-   **Infrastructure Layer** (`infrastructure/supabase/`):
    -   Create migration: `008_create_monthly_costs_table.sql`
    -   Implement `costRepositorySupabase` with Supabase queries
    -   Table structure: `id UUID`, `month TEXT UNIQUE`, `shipping_cost NUMERIC`, `marketing_cost NUMERIC`, `overhead_cost NUMERIC`, `created_at TIMESTAMP`, `updated_at TIMESTAMP`

-   **Usecases Layer** (`core/usecases/revenue.ts`):
    -   Create `computeRevenueByProductType` function
    -   Create `computeRevenueByProduct` function
    -   Update `computeRevenue` to include shipping and indirect costs
    -   Create `getMonthlyShippingCost` usecase
    -   Create `createOrUpdateMonthlyShippingCost` usecase
    -   Create similar usecases for indirect costs

-   **Presentation Layer** (`presentation/hooks/useRevenue.ts`):
    -   Add `useRevenueByProductType` hook
    -   Add `useRevenueByProduct` hook
    -   Add `useMonthlyShippingCost` hook
    -   Add `useUpdateMonthlyShippingCost` mutation hook

-   **Presentation Layer** (`presentation/components/revenueTable/`):
    -   Create `ExpandableRevenueRow` component
    -   Update `RevenueTable` to support expandable rows
    -   Add cost input components for shipping and indirect costs
    -   Add mutation hooks for cost updates

### Database Schema

```sql
CREATE TABLE monthly_costs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    month TEXT NOT NULL UNIQUE, -- Format: YYYY-MM
    shipping_cost NUMERIC(10, 2) DEFAULT 0,
    marketing_cost NUMERIC(10, 2) DEFAULT 0,
    overhead_cost NUMERIC(10, 2) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_monthly_costs_month ON monthly_costs(month);
```

### Expandable Rows Implementation

-   Use React state to manage expansion (open/closed)
-   Lazy load data when row is expanded (use `enabled` option in React Query)
-   Cache expanded data to avoid refetching
-   Use proper ARIA attributes for accessibility (`aria-expanded`, `aria-controls`)

### Cost Input Components

-   Create reusable `CostInput` component for shipping and indirect costs
-   Use controlled inputs with validation
-   Save on blur or explicit save button
-   Show loading state during save
-   Display success/error feedback

## Definition of Done

-   [ ] Database table `monthly_costs` created with migration
-   [ ] Domain types created for `MonthlyCost` and updated `RevenueData`
-   [ ] `CostRepository` interface created
-   [ ] `costRepositorySupabase` implemented
-   [ ] Usecases created for revenue breakdown by type and product
-   [ ] Usecases created for monthly cost management
-   [ ] Hooks created for expandable data and cost mutations
-   [ ] Expandable rows implemented with proper UI/UX
-   [ ] Shipping cost input and save functionality working
-   [ ] Indirect costs (2-3 lines) input and save functionality working
-   [ ] Net result calculation displays correctly
-   [ ] All calculations are accurate
-   [ ] Cost data persists correctly in database
-   [ ] Loading and error states handled properly
-   [ ] Expandable rows are accessible (ARIA attributes)
-   [ ] All existing tests pass
-   [ ] New tests added for usecases and hooks
-   [ ] SCSS uses variables from `styles/variables/*`
-   [ ] No linter errors

## Related Components

### Files to Create

-   `src/infrastructure/supabase/migrations/008_create_monthly_costs_table.sql`
-   `src/core/domain/cost.ts`
-   `src/core/ports/costRepository.ts`
-   `src/infrastructure/supabase/costRepositorySupabase.ts`
-   `src/core/usecases/cost.ts` (for cost management usecases)
-   `src/presentation/hooks/useCost.ts`
-   `src/presentation/components/revenueTable/ExpandableRevenueRow.tsx`
-   `src/presentation/components/revenueTable/CostInput.tsx`

### Files to Modify

-   `src/core/domain/revenue.ts` (add new types)
-   `src/core/usecases/revenue.ts` (add breakdown usecases)
-   `src/presentation/hooks/useRevenue.ts` (add breakdown hooks)
-   `src/presentation/components/revenueTable/RevenueTable.tsx` (add expandable rows and costs)
-   `src/app/dashboard/revenus/page.tsx` (integrate cost inputs)

### Files to Test

-   `__tests__/core/usecases/revenue.test.ts`
-   `__tests__/core/usecases/cost.test.ts`
-   `__tests__/core/domain/cost.test.ts`

## Dependencies

-   Requires FBC-32 (Revenus page MVP) to be completed first
-   Requires existing `ActivityRepository` and `ProductRepository`
-   Requires product types and product domain models

## Notes

-   Shipping costs are entered monthly, not per sale (as specified by user)
-   Indirect costs are predefined lines (2-3) that can be edited per month
-   Expandable rows provide detailed breakdown without cluttering the main table
-   Cost inputs should be intuitive and provide clear feedback
-   All cost data is stored per month (YYYY-MM format) for easy querying
-   The structure prepares for comparison features (FBC-34) even if not implemented yet

