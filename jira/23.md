---
Generated: 2025-01-27 14:30:22
Main Ticker: 22
Ticket Number: 23
---

# Add createProduct and updateProduct usecases

-   Type: Feature
-   Priority: High
-   Story Points: 3
-   Labels: core, usecases, products, validation
-   Git Branch: feat/fbc-23-product-usecases-create-update

## Description

Add business logic usecases for creating and updating products. These usecases will orchestrate validation and delegate to the repository layer, following Clean Architecture principles.

**Current state:**

-   Product domain model exists with all required fields
-   Product repository has `create` and `update` methods implemented
-   Domain validation function `isValidProduct` exists
-   No usecases for creating or updating products yet

**Business requirement:**

-   Products must be validated before creation/update
-   Product updates must verify the product exists
-   Business rules must be enforced (positive prices, non-negative stock, etc.)

## User Story

As a developer, I want product creation and update logic to be centralized in usecases so that business rules are consistently enforced and the codebase follows Clean Architecture principles.

## Acceptance Criteria

### Usecases Implementation

-   [ ] Create `createProduct` usecase in `src/core/usecases/product.ts`
    -   Takes `ProductRepository` and `Omit<Product, 'id'>` as parameters
    -   Validates product data using domain validation (`isValidProduct`)
    -   Delegates to `repository.create()` for persistence
    -   Returns created product with generated ID
    -   Throws error if validation fails
-   [ ] Create `updateProduct` usecase in `src/core/usecases/product.ts`
    -   Takes `ProductRepository`, `ProductId`, and `Partial<Product>` as parameters
    -   Retrieves existing product using `repository.getById()` to verify it exists
    -   Throws error if product not found
    -   Validates merged product data (existing + updates) using domain validation
    -   Delegates to `repository.update()` for persistence
    -   Returns updated product
    -   Throws error if validation fails or product not found

### Testing

-   [ ] Add unit tests for `createProduct` usecase in `__tests__/core/usecases/product.test.ts`
    -   Test successful product creation
    -   Test validation errors (invalid data, missing required fields, negative prices, etc.)
    -   Test repository error handling
    -   Mock repository dependency
-   [ ] Add unit tests for `updateProduct` usecase in `__tests__/core/usecases/product.test.ts`
    -   Test successful product update
    -   Test product not found error
    -   Test validation errors (invalid updates, negative prices, etc.)
    -   Test partial updates (only some fields)
    -   Test repository error handling
    -   Mock repository dependency

## Technical Considerations

### Architecture Layers

-   **Domain layer**: Product type and validation already exist
-   **Usecases layer**: Add `createProduct` and `updateProduct` usecases
-   **Infrastructure layer**: Repository methods already implemented (no changes needed)

### Usecase Patterns

Follow the same patterns as `addActivity` and `updateActivity` usecases:

-   **createProduct**:

    -   Validate input using domain validation
    -   Delegate to repository
    -   Return created product

-   **updateProduct**:
    -   Check product exists (getById)
    -   Merge existing + updates
    -   Validate merged product
    -   Delegate to repository
    -   Return updated product

### Validation

-   Use `isValidProduct` from domain validation
-   Repository enforces database constraints (positive prices, non-negative stock, etc.)
-   Usecases validate business rules before delegating to repository

### Error Handling

-   Throw descriptive errors for validation failures
-   Throw error if product not found (updateProduct)
-   Let repository errors propagate (database errors, constraint violations)

## Definition of Done

-   [ ] `createProduct` usecase implemented in `src/core/usecases/product.ts`
-   [ ] `updateProduct` usecase implemented in `src/core/usecases/product.ts`
-   [ ] Unit tests for `createProduct` pass
-   [ ] Unit tests for `updateProduct` pass
-   [ ] All tests follow project conventions (Jest, TypeScript, mocks)
-   [ ] JSDoc documentation added for both usecases
-   [ ] Build/lint green
-   [ ] No TypeScript errors
-   [ ] Code review approved

## Related Components

### Domain & Usecases

-   `src/core/domain/product.ts` - Product type definition
-   `src/core/domain/validation.ts` - Product validation (`isValidProduct`)
-   `src/core/usecases/product.ts` - Product usecases (add `createProduct`, `updateProduct`)
-   `__tests__/core/usecases/product.test.ts` - Product usecase tests

### Infrastructure

-   `src/core/ports/productRepository.ts` - ProductRepository interface (reference)
-   `src/infrastructure/supabase/productRepositorySupabase.ts` - Repository implementation (reference, no changes)

### Reference Usecases

-   `src/core/usecases/activity.ts` - Activity usecases (`addActivity`, `updateActivity`) - reference for patterns
-   `__tests__/core/usecases/activity.test.ts` - Activity usecase tests - reference for test patterns

## Dependencies

-   Product domain model (already exists)
-   Product validation (`isValidProduct`) (already exists)
-   Product repository with create/update methods (already exists)

## Notes

-   This ticket focuses only on the usecase layer (business logic orchestration)
-   No UI or hooks changes in this ticket
-   Follow the same patterns as Activity usecases for consistency
-   Validation should use domain validation functions, not duplicate logic
