---
Generated: 2025-01-27 21:00:00
Ticket Number: 34
---

# FBC-34: Enhance Revenus page - Comparison with previous period and UX improvements

## Type

Feature

## Priority

Medium

## Story Points

8

## Labels

`feature`, `revenue`, `financial`, `dashboard`, `ux`, `presentation`

## Git Branch

`feat/fbc-34-revenus-comparison-ux`

## Description

Add comparison functionality and UX improvements to the Revenus page:

1. **Period comparison**: Toggle to compare current period with previous period (previous month, previous quarter, or previous year)
2. **Visual indicators**: Show percentage changes (increase/decrease) with color coding
3. **UX improvements**: Loading states, error handling, empty states, export functionality (optional)

This completes the Revenus page feature set. Note: Since the business is just starting, comparison data may not be available yet, but the structure should be prepared and work correctly when data becomes available.

## User Story

As a business owner, I want to compare my current period performance with the previous period so that I can track trends and understand if my business is growing or declining.

## Acceptance Criteria

1. **Comparison toggle**:
   - Add toggle/checkbox "Comparer avec période précédente" in Revenus page
   - Toggle state is managed (on/off)
   - When enabled, fetch data for previous period based on current period type:
     - Month → Previous month
     - Quarter → Previous quarter
     - Year → Previous year
     - Custom → Previous period of same duration

2. **Previous period calculation**:
   - Create utility function to calculate previous period dates
   - Handle edge cases (January → December of previous year, etc.)
   - Calculate previous period correctly for all period types

3. **Comparison display**:
   - Display previous period data alongside current period data
   - Show percentage change for each metric:
     - Revenue: +X% or -X%
     - Costs: +X% or -X%
     - Gross margin: +X% or -X%
     - Net result: +X% or -X%
   - Use color coding: Green for positive, Red for negative, Neutral for zero
   - Display both absolute values and percentage changes

4. **Empty state handling**:
   - When previous period has no data, display "N/A" or "Pas de données"
   - Handle gracefully (no errors, clear messaging)
   - Show message: "Pas de données disponibles pour la période précédente"

5. **Visual improvements**:
   - Improve table layout to accommodate comparison columns
   - Use proper spacing and alignment
   - Make comparison data clearly distinguishable
   - Add icons for increase/decrease indicators (optional)

6. **Export functionality** (optional, nice-to-have):
   - Add "Exporter" button to download revenue data as CSV
   - Include current period and comparison data if comparison is enabled
   - CSV format: columns for current period, previous period, and change

## Technical Considerations

### Architecture Layers Impacted

-   **Shared Layer** (`shared/utils/`):
    -   Create `dateUtils.ts` with `getPreviousPeriod` function
    -   Function accepts: period type, startDate, endDate
    -   Returns: previous period startDate and endDate

-   **Presentation Layer** (`presentation/components/revenueTable/`):
    -   Create `ComparisonToggle` component
    -   Update `RevenueTable` to support comparison display
    -   Add comparison columns to table
    -   Add percentage change calculations and display

-   **Presentation Layer** (`presentation/hooks/useRevenue.ts`):
    -   Update `useRevenue` to accept `compareWithPrevious` boolean
    -   When enabled, fetch both current and previous period data
    -   Return comparison data structure

-   **Presentation Layer** (`app/dashboard/revenus/`):
    -   Add comparison toggle state management
    -   Pass comparison flag to hooks
    -   Handle empty states for previous period

### Comparison Data Structure

```typescript
type RevenueComparison = {
  current: RevenueData;
  previous: RevenueData | null;
  changes: {
    revenue: number; // percentage change
    costs: number;
    grossMargin: number;
    netResult: number;
  };
};
```

### Date Calculation Logic

-   Previous month: Subtract 1 month from start and end dates
-   Previous quarter: Subtract 3 months
-   Previous year: Subtract 1 year
-   Custom: Calculate duration, then subtract that duration from dates

### Percentage Change Calculation

```typescript
function calculatePercentageChange(current: number, previous: number): number {
  if (previous === 0) return current > 0 ? 100 : 0;
  return ((current - previous) / previous) * 100;
}
```

### Color Coding

-   Positive change: Green (use CSS variable from `styles/variables/colors`)
-   Negative change: Red
-   Zero/No change: Neutral gray
-   No data: Muted text

### Export Implementation (Optional)

-   Use `papaparse` or similar library for CSV generation
-   Create `exportRevenueToCSV` utility function
-   Include all revenue data: current period, previous period (if available), changes
-   Trigger download via browser download API

## Definition of Done

-   [ ] `getPreviousPeriod` utility function created and tested
-   [ ] `ComparisonToggle` component created
-   [ ] `RevenueTable` updated to display comparison data
-   [ ] Percentage change calculations implemented correctly
-   [ ] Color coding applied (green/red/neutral)
-   [ ] Empty state handled gracefully (no data for previous period)
-   [ ] Comparison works for all period types (month/quarter/year/custom)
-   [ ] Previous period calculation handles edge cases correctly
-   [ ] Visual layout accommodates comparison columns
-   [ ] All existing functionality still works
-   [ ] Loading states handled for comparison data
-   [ ] Error states handled gracefully
-   [ ] Optional: CSV export functionality implemented
-   [ ] Component is accessible (ARIA labels, keyboard navigation)
-   [ ] SCSS uses variables from `styles/variables/*`
-   [ ] All existing tests pass
-   [ ] New tests added for date utilities and comparison logic
-   [ ] No linter errors

## Related Components

### Files to Create

-   `src/shared/utils/dateUtils.ts`
-   `src/presentation/components/revenueTable/ComparisonToggle.tsx`
-   `src/presentation/components/revenueTable/ComparisonToggle.module.scss`
-   `src/shared/utils/csvExport.ts` (optional, for export)

### Files to Modify

-   `src/presentation/components/revenueTable/RevenueTable.tsx`
-   `src/presentation/hooks/useRevenue.ts` (add comparison support)
-   `src/app/dashboard/revenus/page.tsx` (add toggle and comparison logic)

### Files to Test

-   `__tests__/shared/utils/dateUtils.test.ts`
-   `__tests__/presentation/components/revenueTable/ComparisonToggle.test.tsx` (if component is complex)

## Dependencies

-   Requires FBC-33 (Advanced Revenus features) to be completed first
-   Requires FBC-32 (Revenus MVP) for base functionality

## Notes

-   Since the business is just starting, previous period data may not exist yet
-   The comparison feature should work correctly even when previous period has no data
-   Structure should be prepared for future use when comparison data becomes available
-   Export functionality is optional but adds value for reporting
-   Color coding helps users quickly identify trends (green = good, red = concerning)
-   Percentage changes are more meaningful than absolute values for comparison
-   The comparison toggle should be clearly visible but not intrusive

