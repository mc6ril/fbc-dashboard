---
Generated: 2025-01-27 20:30:00
Ticket Number: 29
Parent Ticket: 26
---

# Update AddActivityForm with cascading product selects (UI layer)

-   Type: Feature
-   Priority: Medium
-   Story Points: 5
-   Labels: ui, forms, products, activity, components
-   Git Branch: feat/fbc-29-cascading-product-selects-ui

## Description

Update the AddActivityForm component to replace the single "Product" select with three cascading selects: Product Type → Product Model → Coloris. Implement filtering logic, auto-selection of unique coloris, and proper form validation.

**Current state:**
-   AddActivityForm has a single "Product" select showing all products
-   Product selection displays: `"Charlie - Rose pâle à motifs (POCHETTE_VOLANTS)"`
-   No filtering or cascading behavior

**Business requirement:**
-   Replace single select with three cascading selects
-   Product Type select shows all available types
-   Product Model select is filtered by selected type
-   Coloris select is filtered by selected type + model
-   Auto-select coloris if only one is available
-   Map final selection to productId for form submission

## User Story

**As a** user creating an activity  
**I want** to select products using cascading dropdowns (Type → Model → Coloris)  
**So that** I can quickly find and select the exact product I need

## Acceptance Criteria

-   [ ] Replace single "Product" select with three selects: Product Type, Product Model, Coloris
-   [ ] Product Type select shows all available product types (POCHETTE_VOLANTS, SAC_BANANE, etc.)
-   [ ] Product Model select is filtered by selected Product Type
    -   Shows only unique model names (name field) for the selected type
    -   Disabled when no type is selected
    -   Reset when type changes
-   [ ] Coloris select is filtered by selected Product Type + Model
    -   Shows only unique coloris for the selected type + model combination
    -   Disabled when no type or model is selected
    -   Reset when type or model changes
-   [ ] Auto-select coloris if only one is available for the selected model
-   [ ] Final product selection correctly maps to `productId` matching (type + name + coloris)
-   [ ] Form validation ensures all three fields are selected when product is required
-   [ ] All three selects are properly labeled and accessible (WCAG 2.1 AA)
-   [ ] Form maintains existing functionality for activity creation
-   [ ] Component uses SCSS variables for all styling (no hardcoded values)
-   [ ] Component is memoized appropriately
-   [ ] Component has proper TypeScript types

## Technical Considerations

**Clean Architecture:**
-   Presentation layer only (`presentation/components/addActivity/`)
-   Uses existing `useProducts` hook or new filtering hooks from ticket #27
-   No business logic in component (filtering logic can be in hooks or usecases)

**State management:**
-   Add state: `selectedProductType`, `selectedProductModel`, `selectedColoris`
-   Derive filtered options using `useMemo` based on selected values
-   Reset dependent selects when parent select changes

**Filtering logic:**
```typescript
// Product Type options: Extract unique types from products
const productTypes = useMemo(() => {
  const types = new Set(products?.map(p => p.type) || []);
  return Array.from(types).map(type => ({ value: type, label: type }));
}, [products]);

// Product Model options: Filter by selected type
const productModels = useMemo(() => {
  if (!selectedProductType || !products) return [];
  const filtered = products.filter(p => p.type === selectedProductType);
  const models = new Set(filtered.map(p => p.name));
  return Array.from(models).map(name => ({ value: name, label: name }));
}, [products, selectedProductType]);

// Coloris options: Filter by selected type + model
const colorisOptions = useMemo(() => {
  if (!selectedProductType || !selectedProductModel || !products) return [];
  const filtered = products.filter(
    p => p.type === selectedProductType && p.name === selectedProductModel
  );
  const coloris = new Set(filtered.map(p => p.coloris));
  return Array.from(coloris).map(coloris => ({ value: coloris, label: coloris }));
}, [products, selectedProductType, selectedProductModel]);

// Auto-select coloris if only one
useEffect(() => {
  if (colorisOptions.length === 1 && !selectedColoris) {
    setSelectedColoris(colorisOptions[0].value);
  }
}, [colorisOptions, selectedColoris]);

// Find productId from (type + name + coloris)
const productId = useMemo(() => {
  if (!selectedProductType || !selectedProductModel || !selectedColoris || !products) {
    return undefined;
  }
  const product = products.find(
    p => p.type === selectedProductType && 
         p.name === selectedProductModel && 
         p.coloris === selectedColoris
  );
  return product?.id;
}, [products, selectedProductType, selectedProductModel, selectedColoris]);
```

**Validation:**
-   Update validation to check all three fields when product is required
-   Show error messages for each field if validation fails

## Definition of Done

-   [ ] Three cascading selects implemented in AddActivityForm
-   [ ] Filtering logic works correctly (Type → Model → Coloris)
-   [ ] Auto-selection works when only one coloris is available
-   [ ] Form validation updated for three-field product selection
-   [ ] Final productId correctly mapped from (type + name + coloris) combination
-   [ ] All selects are accessible (WCAG 2.1 AA): proper labels, ARIA attributes
-   [ ] Component uses SCSS variables for all styling (no hardcoded values)
-   [ ] Component tested (unit tests updated in `__tests__/presentation/components/addActivity/AddActivityForm.test.tsx`)
-   [ ] Lint/build passes
-   [ ] Component documented with JSDoc

## Related Components

-   `src/presentation/components/addActivity/AddActivityForm/AddActivityForm.tsx` - Main component to update
-   `src/presentation/hooks/useProducts.ts` - May use existing hook or new filtering hooks
-   `__tests__/presentation/components/addActivity/AddActivityForm.test.tsx` - Tests to update

## Dependencies

-   Ticket #27 (Product filtering usecases) - Should be completed first (or filter in-memory in component)
-   Ticket #14 (Add Activity page) - Must be completed first
-   Products must exist in database with correct structure (name, type, coloris)

## Notes

-   This ticket focuses on UI/UX changes only
-   Filtering can be done in-memory in the component using existing `useProducts` hook
-   Can use usecases from ticket #27 if available, or filter directly in component
-   Auto-selection improves UX by reducing clicks
-   Stock management remains unchanged - each product (type + name + coloris) has its own stock

