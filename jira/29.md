---
Generated: 2025-01-27 21:00:00
Ticket Number: 29
---

# Connect activity with stock

-   Type: Feature
-   Priority: High
-   Story Points: 8
-   Labels: backend, activity, stock, integration, data-consistency
-   Git Branch: feat/fbc-29-connect-activity-with-stock

## Description

When a new activity is created, the stock must be updated accordingly through stock movements. Currently, activities and stock movements are separate entities, and stock is computed from activities. This ticket implements automatic stock movement creation when activities are created, ensuring data consistency and enabling efficient stock tracking.

**Current problem:**

-   Activities are created independently without creating corresponding stock movements
-   Stock is computed from activities using `computeStockFromActivities`, which is inefficient for large datasets
-   No automatic synchronization between activities and stock movements
-   Dashboards may not reflect stock changes immediately after activity creation

**Proposed solution:**

-   When a SALE activity is created (quantity -1), automatically create a stock movement with source SALE (quantity -1)
-   When a CREATION activity is created (quantity +1), automatically create a stock movement with source CREATION (quantity +1)
-   When a STOCK_CORRECTION activity is created, automatically create a stock movement with source INVENTORY_ADJUSTMENT
-   Each activity creation triggers React Query cache invalidation to update dashboards immediately

## User Story

**As a** FBC dashboard user  
**I want** stock to be automatically updated when I create an activity  
**So that** stock levels are always accurate and dashboards reflect changes immediately

## Acceptance Criteria

### Activity → Stock Movement Mapping

-   [ ] When a CREATION activity is created with `productId` and `quantity > 0`, a stock movement is automatically created with:
    -   `productId`: same as activity
    -   `quantity`: same as activity quantity (positive)
    -   `source`: `StockMovementSource.CREATION`
-   [ ] When a SALE activity is created with `productId` and `quantity < 0`, a stock movement is automatically created with:
    -   `productId`: same as activity
    -   `quantity`: same as activity quantity (negative)
    -   `source`: `StockMovementSource.SALE`
-   [ ] When a STOCK_CORRECTION activity is created with `productId` and `quantity != 0`, a stock movement is automatically created with:
    -   `productId`: same as activity
    -   `quantity`: same as activity quantity (positive or negative)
    -   `source`: `StockMovementSource.INVENTORY_ADJUSTMENT`
-   [ ] When an OTHER activity is created, no stock movement is created (OTHER activities don't affect stock)
-   [ ] When an activity is created without `productId`, no stock movement is created (stock movements require a product)

### Data Consistency

-   [ ] Stock movement creation is atomic with activity creation (both succeed or both fail)
-   [ ] If stock movement creation fails, activity creation is rolled back (transaction)
-   [ ] Stock movements are created only for activities that affect stock (CREATION, SALE, STOCK_CORRECTION with productId)
-   [ ] Stock movement quantity matches activity quantity exactly (no transformation)

### Dashboard Updates

-   [ ] When an activity is created, React Query cache is invalidated for:
    -   Activities list queries (`["activities"]`)
    -   Dashboard recent activities query (`queryKeys.dashboard.recentActivities()`)
    -   Stock-related queries (if any exist)
-   [ ] Dashboards reflect stock changes immediately after activity creation
-   [ ] No manual refresh is required to see updated stock levels

### Error Handling

-   [ ] If stock movement creation fails, the error is propagated and activity creation fails
-   [ ] Error messages are clear and indicate which operation failed (activity or stock movement)
-   [ ] Validation errors are handled appropriately (missing productId, invalid quantity, etc.)

## Technical Implementation

### Infrastructure Layer (`infrastructure/supabase/`)

**Create `stockMovementRepositorySupabase.ts`:**

-   [ ] Implement `StockMovementRepository` interface
-   [ ] Map Supabase `stock_movements` table rows to domain `StockMovement` types
-   [ ] Handle NUMERIC to number conversion (Supabase returns NUMERIC as string)
-   [ ] Implement `create`, `list`, `getById`, and `listByProduct` methods
-   [ ] Use `supabaseClient` from `./client`
-   [ ] Follow same patterns as `activityRepositorySupabase.ts`

**Mapping:**

```typescript
// Supabase row type
type SupabaseStockMovementRow = {
    id: string;
    product_id: string;
    quantity: string; // NUMERIC returned as string
    source: string;
};

// Domain type
type StockMovement = {
    id: StockMovementId;
    productId: ProductId;
    quantity: number;
    source: StockMovementSource;
};
```

### Usecases Layer (`core/usecases/`)

**Create `stockMovement.ts`:**

-   [ ] Create `createStockMovement` usecase that:
    -   Validates `productId` is provided
    -   Validates `quantity` is non-zero
    -   Validates `source` is valid `StockMovementSource`
    -   Delegates to repository
-   [ ] Create `listStockMovements` usecase (for future use)
-   [ ] Create `listStockMovementsByProduct` usecase (for future use)

**Modify `activity.ts`:**

-   [ ] Update `addActivity` usecase to:
    -   Accept `StockMovementRepository` as additional parameter
    -   After creating activity, check if stock movement should be created
    -   Map `ActivityType` to `StockMovementSource`:
        -   `ActivityType.CREATION` → `StockMovementSource.CREATION`
        -   `ActivityType.SALE` → `StockMovementSource.SALE`
        -   `ActivityType.STOCK_CORRECTION` → `StockMovementSource.INVENTORY_ADJUSTMENT`
        -   `ActivityType.OTHER` → skip (no stock movement)
    -   Create stock movement only if:
        -   Activity has `productId`
        -   Activity `quantity` is non-zero
        -   Activity type is CREATION, SALE, or STOCK_CORRECTION
    -   Handle errors: if stock movement creation fails, throw error (activity creation will be rolled back by Supabase transaction if using RPC)

**Transaction handling:**

-   Option A (recommended): Use Supabase RPC function to create activity and stock movement atomically
-   Option B: Create activity first, then stock movement, and handle rollback manually if stock movement fails
-   Option C: Use Supabase transaction (if supported) to ensure atomicity

**Usecase signature:**

```typescript
export const addActivity = async (activityRepo: ActivityRepository, stockMovementRepo: StockMovementRepository, activity: Omit<Activity, "id">): Promise<Activity> => {
    // Validate activity (existing logic)
    // Create activity
    const createdActivity = await activityRepo.create(activity);

    // Create stock movement if needed
    if (shouldCreateStockMovement(createdActivity)) {
        const stockMovement = mapActivityToStockMovement(createdActivity);
        await stockMovementRepo.create(stockMovement);
    }

    return createdActivity;
};
```

### Presentation Layer (`presentation/hooks/`)

**Modify `useActivities.ts`:**

-   [ ] Update `useAddActivity` hook to:
    -   Import `stockMovementRepositorySupabase`
    -   Pass both repositories to `addActivity` usecase
    -   Invalidate stock-related queries on success (if any exist)
-   [ ] Ensure React Query cache invalidation includes stock movements queries

**Example:**

```typescript
export const useAddActivity = () => {
    const queryClient = useQueryClient();
    // ... existing code ...

    return useMutation<Activity, ActivityError | Error, Omit<Activity, "id">>({
        mutationFn: (activity: Omit<Activity, "id">) =>
            addActivity(
                activityRepositorySupabase,
                stockMovementRepositorySupabase, // Add this
                activity
            ),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["activities"] });
            queryClient.invalidateQueries({ queryKey: queryKeys.dashboard.recentActivities() });
            queryClient.invalidateQueries({ queryKey: ["stock-movements"] }); // Add this
        },
        // ... rest of code ...
    });
};
```

### Domain Layer (`core/domain/`)

-   [ ] Verify `StockMovement` and `StockMovementSource` types are correct (already exist)
-   [ ] No modifications needed in domain layer

### Helper Functions

**Create mapping function:**

```typescript
function mapActivityToStockMovement(activity: Activity): Omit<StockMovement, "id"> | null {
    // Only create stock movement for activities with productId
    if (!activity.productId) {
        return null;
    }

    // Only create stock movement for CREATION, SALE, STOCK_CORRECTION
    if (activity.type === ActivityType.OTHER) {
        return null;
    }

    // Map ActivityType to StockMovementSource
    let source: StockMovementSource;
    switch (activity.type) {
        case ActivityType.CREATION:
            source = StockMovementSource.CREATION;
            break;
        case ActivityType.SALE:
            source = StockMovementSource.SALE;
            break;
        case ActivityType.STOCK_CORRECTION:
            source = StockMovementSource.INVENTORY_ADJUSTMENT;
            break;
        default:
            return null;
    }

    // Only create if quantity is non-zero
    if (activity.quantity === 0) {
        return null;
    }

    return {
        productId: activity.productId,
        quantity: activity.quantity,
        source,
    };
}
```

## Definition of Done

-   [ ] All acceptance criteria are met
-   [ ] `stockMovementRepositorySupabase.ts` is implemented and tested
-   [ ] `createStockMovement` usecase is implemented and tested
-   [ ] `addActivity` usecase creates stock movements automatically
-   [ ] Activity → Stock Movement mapping works correctly for all activity types
-   [ ] Stock movements are created atomically with activities (transaction)
-   [ ] React Query cache invalidation updates dashboards immediately
-   [ ] Unit tests pass for all new code
-   [ ] Integration tests verify activity + stock movement creation
-   [ ] Error handling is robust (rollback on failure)
-   [ ] Code is reviewed and approved
-   [ ] JSDoc documentation is updated
-   [ ] No hardcoded values (use SCSS variables if applicable)

## Related Components

-   `src/core/domain/activity.ts` - Activity domain types (no modification needed)
-   `src/core/domain/stockMovement.ts` - StockMovement domain types (no modification needed)
-   `src/core/ports/stockMovementRepository.ts` - Repository port interface (already exists)
-   `src/core/usecases/activity.ts` - **Usecase to modify** (add stock movement creation)
-   `src/core/usecases/stockMovement.ts` - **Usecase to create** (new file)
-   `src/infrastructure/supabase/stockMovementRepositorySupabase.ts` - **Repository to create** (new file)
-   `src/presentation/hooks/useActivities.ts` - **Hook to modify** (pass stock movement repository)
-   `src/infrastructure/supabase/migrations/001_create_domain_tables.sql` - Database schema (already has `stock_movements` table)

## Sub-Tickets

### Sub-Ticket 29.1

**Title:** Implement Supabase StockMovementRepository

**Description:** Create the Supabase implementation of `StockMovementRepository` interface following the same patterns as `activityRepositorySupabase.ts`.

**Acceptance Criteria:**

-   [ ] `stockMovementRepositorySupabase.ts` implements `StockMovementRepository` interface
-   [ ] All methods (`create`, `list`, `getById`, `listByProduct`) are implemented
-   [ ] Supabase row types are mapped to domain types correctly
-   [ ] NUMERIC fields are converted from string to number
-   [ ] Error handling follows same patterns as other repositories
-   [ ] Unit tests are written and pass

**Estimated Effort:** 3h

### Sub-Ticket 29.2

**Title:** Create stock movement usecases

**Description:** Create usecases for stock movement operations, including `createStockMovement` that validates input and delegates to repository.

**Acceptance Criteria:**

-   [ ] `createStockMovement` usecase validates `productId` is provided
-   [ ] `createStockMovement` usecase validates `quantity` is non-zero
-   [ ] `createStockMovement` usecase validates `source` is valid
-   [ ] `listStockMovements` usecase is created (for future use)
-   [ ] `listStockMovementsByProduct` usecase is created (for future use)
-   [ ] Unit tests are written and pass

**Estimated Effort:** 2h

### Sub-Ticket 29.3

**Title:** Integrate stock movement creation into addActivity usecase

**Description:** Modify `addActivity` usecase to automatically create stock movements when activities are created, ensuring atomicity and proper error handling.

**Acceptance Criteria:**

-   [ ] `addActivity` accepts `StockMovementRepository` as parameter
-   [ ] Stock movements are created for CREATION, SALE, and STOCK_CORRECTION activities with productId
-   [ ] Stock movements are NOT created for OTHER activities or activities without productId
-   [ ] Activity → Stock Movement mapping is correct (type and quantity)
-   [ ] Transaction handling ensures atomicity (both succeed or both fail)
-   [ ] Error handling propagates errors correctly
-   [ ] Unit tests are written and pass

**Estimated Effort:** 3h

### Sub-Ticket 29.4

**Title:** Update React Query hooks and cache invalidation

**Description:** Update `useAddActivity` hook to pass stock movement repository and invalidate stock-related queries on success.

**Acceptance Criteria:**

-   [ ] `useAddActivity` passes `stockMovementRepositorySupabase` to `addActivity` usecase
-   [ ] Stock movements queries are invalidated on activity creation success
-   [ ] Dashboards reflect stock changes immediately
-   [ ] No manual refresh is required
-   [ ] Unit tests are written and pass

**Estimated Effort:** 1h

## Dependencies

-   ✅ Ticket #10 (Create Supabase tables) - **Already completed** (stock_movements table exists)
-   ✅ Ticket #11 (Implement Supabase repositories) - **Partially completed** (ActivityRepository exists, StockMovementRepository missing)
-   ✅ Ticket #14 (Add Activity page) - **Already completed**
-   ⏳ Sub-Ticket 29.1 (Implement Supabase StockMovementRepository) - **To complete first**
-   ⏳ Sub-Ticket 29.2 (Create stock movement usecases) - **To complete second**
-   ⏳ Sub-Ticket 29.3 (Integrate stock movement creation) - **To complete third**
-   ⏳ Sub-Ticket 29.4 (Update React Query hooks) - **To complete last**

## Notes

-   **Transaction handling**: Consider using Supabase RPC function to ensure atomicity. If RPC is not used, implement manual rollback logic.
-   **Stock movement source mapping**: `ActivityType.STOCK_CORRECTION` maps to `StockMovementSource.INVENTORY_ADJUSTMENT` (different naming but same concept).
-   **Quantity sign**: Stock movement quantity matches activity quantity exactly (no transformation). CREATION activities have positive quantities, SALE activities have negative quantities.
-   **Performance**: Creating stock movements automatically may add slight overhead, but ensures data consistency and enables efficient stock queries.
-   **Future optimization**: Consider using database triggers or Supabase functions to create stock movements automatically at the database level (out of scope for this ticket).

## Questions to clarify

1. Should we use Supabase RPC function for atomic transaction, or implement manual rollback?
2. Should stock movements be created for activities with `quantity === 0`? (currently planned to skip)
3. Should we create stock movements for historical activities (migration), or only for new activities? (out of scope for this ticket)
4. Should dashboards use stock movements or activities for stock calculation? (currently uses activities, may change in future)
