---
Generated: 2025-01-27 20:45:00
Ticket Number: 28
---

# Fix add activities form to adapt to activity type

-   Type: Feature
-   Priority: High
-   Story Points: 5
-   Labels: ui, forms, activity, validation, ux
-   Git Branch: feat/fbc-28-activity-type-specific-form-fields

## Description

Adapt the "Add activity" form to display and validate fields according to the selected activity type. Currently, all activity types display the same fields (quantity and amount), which creates confusion for users and can lead to input errors.

**Current problem:**

-   The "Amount" field is always displayed and required, even for stock creations and corrections where it is not relevant
-   Quantity can be entered as negative or positive depending on the type, which is confusing
-   For sales, users must manually enter a negative quantity, which is counter-intuitive

**Proposed solution:**

-   **CREATION**: Hide the amount field, quantity always positive (user enters positive, system sends positive)
-   **SALE**: Display the amount field, quantity always negative (user enters positive like "2", system sends "-2")
-   **STOCK_CORRECTION**: Hide the amount field, quantity can be positive or negative (improve UX with clear labels or two separate fields)

## User Story

**As a** FBC dashboard user  
**I want** the add activity form to automatically adapt to the selected activity type  
**So that** I can enter data correctly without confusion about positive/negative values and required fields

## Acceptance Criteria

### CREATION (Creation)

-   [ ] The "Amount" field is hidden for CREATION type
-   [ ] The "Quantity" field is displayed with the label "Quantity"
-   [ ] Validation requires quantity to be a positive number strictly greater than 0
-   [ ] User always enters a positive number (e.g., "5")
-   [ ] System sends the quantity as-is (positive) on submission
-   [ ] Helper text indicates "Quantity added to stock" or similar

### SALE (Sale)

-   [ ] The "Amount" field is displayed and required for SALE type
-   [ ] The "Quantity" field is displayed with the label "Quantity sold" or similar
-   [ ] Validation requires quantity to be a positive number strictly greater than 0
-   [ ] User always enters a positive number (e.g., "2" to sell 2 units)
-   [ ] System automatically converts quantity to negative on submission (e.g., user enters "2", system sends "-2")
-   [ ] Helper text indicates "Enter the number of units sold (will be deducted from stock)" or similar
-   [ ] Amount validation remains unchanged (amount > 0)

### STOCK_CORRECTION (Stock Correction)

-   [ ] The "Amount" field is hidden for STOCK_CORRECTION type
-   [ ] The "Quantity" field can be improved with better UX (see options below)
-   [ ] Option A (recommended): Two separate fields "Add to stock" and "Reduce from stock"
    -   User always enters positive numbers in each field
    -   Only one of the two fields can be filled at a time
    -   System calculates final quantity: `addition - reduction` (can be positive or negative)
-   [ ] Option B (alternative): Single "Quantity" field with a select for "Add" or "Reduce"
    -   Select with options: "Add to stock" / "Reduce from stock"
    -   Quantity field always positive
    -   System applies the sign according to the selection
-   [ ] Option C (simple): Keep a single "Quantity" field but improve the label and helper text
    -   Label: "Quantity (positive to add, negative to reduce)"
    -   Helper text: "Enter a positive number to add to stock, negative to reduce"
    -   Validation accepts positive and negative values
-   [ ] Validation requires quantity to be a non-zero number (positive or negative)
-   [ ] System sends the quantity as-is (positive or negative) on submission

### OTHER (Other)

-   [ ] Current behavior is preserved (amount and quantity displayed, both required)
-   [ ] Quantity can be positive or negative (no automatic conversion)

### General

-   [ ] Validation logic is updated for each activity type
-   [ ] Validation errors are clear and specific to the activity type
-   [ ] Form updates dynamically when activity type changes (hide/show fields, reset values if necessary)
-   [ ] Unit tests are updated to cover new behaviors
-   [ ] Accessibility is maintained (WCAG 2.1 AA)
-   [ ] Labels and helper texts are clear and explicit

## Technical Implementation

### Domain Layer (`core/domain/activity.ts`)

-   ✅ Existing types (`Activity`, `ActivityType`) are already correct
-   ✅ No modification needed in the domain layer

### Usecases Layer (`core/usecases/activity.ts`)

-   ✅ Existing business logic already handles positive/negative quantities
-   ✅ No modification needed in usecases (conversion happens in presentation)

### Presentation Layer (`presentation/components/addActivity/AddActivityForm/`)

**Main modifications:**

1. **Form state:**

    - Add state to manage "add" vs "reduce" mode for STOCK_CORRECTION (if Option A or B chosen)

2. **Validation logic (`validateForm`):**

    ```typescript
    // For CREATION: quantity > 0, no amount
    if (activityType === ActivityType.CREATION) {
        if (!quantity || quantity.trim() === "") {
            newErrors.quantity = "Quantity is required";
        } else {
            const quantityNum = Number.parseFloat(quantity);
            if (quantityNum <= 0) {
                newErrors.quantity = "Quantity must be greater than 0";
            }
        }
        // No amount validation for CREATION
    }

    // For SALE: quantity > 0 (will be converted to negative), amount required
    if (activityType === ActivityType.SALE) {
        if (!quantity || quantity.trim() === "") {
            newErrors.quantity = "Quantity is required";
        } else {
            const quantityNum = Number.parseFloat(quantity);
            if (quantityNum <= 0) {
                newErrors.quantity = "Quantity must be greater than 0";
            }
        }
        // Amount validation unchanged
    }

    // For STOCK_CORRECTION: non-zero quantity (positive or negative), no amount
    if (activityType === ActivityType.STOCK_CORRECTION) {
        // Validation according to chosen option (A, B, or C)
    }
    ```

3. **Form submission (`handleSubmit`):**

    ```typescript
    let finalQuantity = Number.parseFloat(quantity);

    // Conversion for SALE: positive → negative
    if (activityType === ActivityType.SALE) {
        finalQuantity = -Math.abs(finalQuantity);
    }

    // For STOCK_CORRECTION with Option A: calculate addition - reduction
    if (activityType === ActivityType.STOCK_CORRECTION && option === "A") {
        const addition = Number.parseFloat(addToStock) || 0;
        const reduction = Number.parseFloat(reduceFromStock) || 0;
        finalQuantity = addition - reduction;
    }

    const activityData = {
        date,
        type: activityType,
        productId: productId as ProductId | undefined,
        quantity: finalQuantity,
        amount: activityType === ActivityType.SALE || activityType === ActivityType.OTHER ? Number.parseFloat(amount) : 0, // Amount set to 0 for CREATION and STOCK_CORRECTION
        note: note.trim() || undefined,
    };
    ```

4. **Conditional field rendering:**

    ```typescript
    const showAmountField = activityType === ActivityType.SALE || activityType === ActivityType.OTHER;

    const showQuantityField = true; // Always displayed

    // Dynamic labels according to type
    const quantityLabel =
        activityType === ActivityType.SALE
            ? "Quantity sold"
            : activityType === ActivityType.STOCK_CORRECTION && option === "A"
            ? "Add to stock / Reduce from stock" // Two separate fields
            : "Quantity";
    ```

### Tests (`__tests__/presentation/components/addActivity/`)

-   [ ] Update existing tests for new behaviors
-   [ ] Add tests for type-specific validation
-   [ ] Add tests for positive → negative quantity conversion for SALE
-   [ ] Add tests for conditional hide/show of fields

## Definition of Done

-   [ ] All acceptance criteria are met
-   [ ] Form correctly adapts to activity type changes
-   [ ] Validation works correctly for each type
-   [ ] Positive → negative quantity conversion works for SALE
-   [ ] Unit tests pass and cover all cases
-   [ ] Accessibility is maintained (WCAG 2.1 AA)
-   [ ] Code is reviewed and approved
-   [ ] Labels and helper texts are clear and translated if necessary
-   [ ] Component uses SCSS variables (no hardcoded values)
-   [ ] JSDoc documentation is updated

## Related Components

-   `src/presentation/components/addActivity/AddActivityForm/AddActivityForm.tsx` - **Component to modify**
-   `src/core/domain/activity.ts` - Domain types (no modification needed)
-   `src/core/usecases/activity.ts` - Usecases (no modification needed)
-   `__tests__/presentation/components/addActivity/AddActivityForm/AddActivityForm.test.tsx` - **Tests to update**

## Sub-Tickets

### Sub-Ticket 28.1 ✅

**Title:** Verify and adapt Supabase database for form changes

**Status:** ✅ **COMPLETED - Database compatible, no modification needed**

**Rationale:**
Before implementing form changes, ensure that the database structure (`activities` table) and data types are compatible with the new requirements:

-   Send `amount: 0` for CREATION and STOCK_CORRECTION (instead of hiding the field)
-   Send negative quantities for SALE (automatic conversion)
-   Send positive or negative quantities for STOCK_CORRECTION

**Acceptance Criteria:**

-   [x] ✅ Verify that the `amount` column in `activities` table accepts value `0` (NOT NULL but can be 0)
    -   **Result:** `amount NUMERIC(10, 2) NOT NULL` - The `NOT NULL` constraint only prevents NULL values, not the value 0. ✅ Compatible
-   [x] ✅ Verify that the `quantity` column in `activities` table accepts negative values (no CHECK constraint preventing negative values)
    -   **Result:** `quantity NUMERIC(10, 2) NOT NULL` - No CHECK constraint preventing negative values. ✅ Compatible
-   [x] ✅ Verify that the `Activity` type in `core/domain/activity.ts` accepts `amount: 0` (type `number`, not `number | null`)
    -   **Result:** `amount: number` - The `number` type accepts 0. ✅ Compatible
-   [x] ✅ Verify that the `activityRepositorySupabase` repository can map `amount: 0` correctly
    -   **Result:** The `mapActivityToSupabaseRow` mapping accepts `amount: number` and converts it correctly. ✅ Compatible
-   [x] ✅ If modifications are needed: **No modification needed**
-   [x] ✅ If everything is compatible:
    -   [x] ✅ Document compatibility in this ticket
    -   [x] ✅ Mark ticket as completed

**Detailed verification:**

1. **Database (`001_create_domain_tables.sql`):**

    ```sql
    CREATE TABLE IF NOT EXISTS activities (
        ...
        quantity NUMERIC(10, 2) NOT NULL,  -- ✅ Accepts negative values (no CHECK)
        amount NUMERIC(10, 2) NOT NULL,     -- ✅ Accepts 0 (NOT NULL ≠ no 0)
        ...
    );
    ```

    - ✅ `amount NOT NULL` accepts value `0` (only NULL is forbidden)
    - ✅ `quantity NOT NULL` accepts negative values (no CHECK constraint)

2. **TypeScript types (`core/domain/activity.ts`):**

    ```typescript
    export type Activity = {
        ...
        quantity: number;  // ✅ Accepts negative and positive values
        amount: number;    // ✅ Accepts 0
        ...
    };
    ```

    - ✅ `number` type accepts 0 and negative values

3. **Repository (`activityRepositorySupabase.ts`):**
    ```typescript
    const mapActivityToSupabaseRow = (activity: ...): SupabaseActivityPayload => {
        ...
        if ("amount" in activity && activity.amount !== undefined) {
            payload.amount = activity.amount;  // ✅ Accepts 0
        }
        if ("quantity" in activity && activity.quantity !== undefined) {
            payload.quantity = activity.quantity;  // ✅ Accepts negative values
        }
        ...
    };
    ```
    - ✅ Mapping accepts `amount: 0` and negative `quantity` without issue

**Conclusion:**
✅ **The database, TypeScript types, and repository are already 100% compatible with the planned changes. No modification needed.**

**Definition of Done:**

-   [x] ✅ Complete verification performed
-   [x] ✅ Database compatible (no migration needed)
-   [x] ✅ TypeScript types compatible (no modification needed)
-   [x] ✅ Repository compatible (no modification needed)
-   [x] ✅ Documentation added to this ticket

**Estimated Effort:** 0.5h (verification completed)

**Owner:** Architecture-Aware Dev

**Risk Notes:** ✅ No risk - everything is already compatible. The ticket can be marked as completed.

## Dependencies

-   ✅ Ticket #14 (Add Activity page) - **Already completed**
-   ✅ Ticket #27 (Cascading product selects) - **Already completed**
-   ⏳ Sub-Ticket 28.1 (Database compatibility check) - **To complete first**

## Notes

-   **Recommended option for STOCK_CORRECTION**: Option A (two separate fields) offers the best UX because users always enter positive numbers and the system calculates the difference
-   **Alternative Option B**: Simpler to implement but less intuitive
-   **Alternative Option C**: Minimal solution if we want to avoid major changes
-   Positive → negative quantity conversion for SALE happens only in the presentation layer, not in domain/usecases (domain already accepts negative quantities)
-   Amount is sent as 0 for CREATION and STOCK_CORRECTION (or can be omitted if the Activity type allows it)

## Questions to clarify

1. Which option to choose for STOCK_CORRECTION? (Option A recommended)
2. Should we allow modifying the amount for CREATION/STOCK_CORRECTION if users want to record a cost? (currently not planned)
3. Should helper text be translated to English or remain in French?
