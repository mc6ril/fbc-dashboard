---
Generated: 2025-01-27 19:00:00
Ticket Number: 4
---

## Jira Ticket

**Title:** Implement persistent session management with real-time cross-tab synchronization

**Type:** Feature

**Priority:** Medium

**Story Points:** 3

**Labels:** authentication, session-management, user-experience, real-time

**Git Branch:** `feat/fbc-4-persistent-sessions-sync`

**Branch Creation:**

```bash
git checkout -b feat/fbc-4-persistent-sessions-sync
```

---

**Description:**

Currently, the FBC Dashboard uses Supabase authentication with session persistence enabled, but there is no real-time detection of session changes across browser tabs. This ticket implements:

1. **Persistent Session Management**: Sessions remain active as long as Supabase considers the token valid, automatically disconnecting when the token expires or is invalidated
2. **Real-time Cross-Tab Synchronization**: Session changes (sign in/out, token refresh, expiration) are synchronized across all browser tabs and windows in real-time using Supabase's `onAuthStateChange` listener

This feature ensures a seamless user experience with persistent sessions across browser tabs and windows, automatically handling token expiration and invalidation.

**Current State:**

-   ✅ Supabase client configured with `persistSession: true` and `autoRefreshToken: true`
-   ✅ Sessions stored in localStorage
-   ✅ React Query hooks for session management (`useSession`, `useUser`)
-   ✅ Zustand store for authentication state
-   ❌ No real-time session change detection (`onAuthStateChange` listener not implemented)
-   ❌ No cross-tab session synchronization

**User Story:**

As a user
I want my session to remain active across browser tabs and windows as long as Supabase considers my token valid, and automatically disconnect when the token expires
So that I can maintain my workflow seamlessly without manually refreshing or re-authenticating when sessions expire

---

**Acceptance Criteria:**

-   [ ] AC1: `onAuthStateChange` listener implemented using Supabase's `auth.onAuthStateChange()` method
-   [ ] AC2: Session changes in one tab/window are synchronized to all other tabs/windows in real-time
-   [ ] AC3: When Supabase detects token expiration or invalidation, user is automatically signed out across all tabs
-   [ ] AC4: When Supabase detects token refresh (`TOKEN_REFRESHED` event), session is updated across all tabs
-   [ ] AC5: When user signs out in one tab, session is invalidated in all other tabs via `SIGNED_OUT` event
-   [ ] AC6: Session state updates trigger React Query cache invalidation to refetch user/session data
-   [ ] AC7: Session state updates trigger Zustand store updates for immediate UI updates
-   [ ] AC8: No memory leaks from event listeners (proper cleanup on component unmount)
-   [ ] AC9: Listener is set up at app initialization and persists across all pages
-   [ ] AC10: Error handling for cases where `onAuthStateChange` fails to subscribe

---

**Technical Considerations:**

-   **Architecture Layers Impacted:**

    -   **Domain** (`core/domain/`):

        -   Add `SessionChangeEvent` type to represent session change events from Supabase

    -   **Ports** (`core/ports/`):

        -   Extend `AuthRepository` interface with method:
            -   `onAuthStateChange(callback: (event: SessionChangeEvent) => void): () => void` - Subscribe to auth state changes

    -   **Usecases** (`core/usecases/`):

        -   Add `subscribeToAuthChanges(repo: AuthRepository, callback: (event: SessionChangeEvent) => void): () => void` - Subscribe to auth state changes

    -   **Infrastructure** (`infrastructure/`):

        -   Update `authRepositorySupabase.ts` to implement `onAuthStateChange` using Supabase's `auth.onAuthStateChange()`
        -   Map Supabase events to domain `SessionChangeEvent` type

    -   **Presentation** (`presentation/`):
        -   **Hooks** (`presentation/hooks/`):
            -   Create `useAuthStateChange.ts` hook to subscribe to auth state changes and update stores/cache
        -   **Providers** (`presentation/providers/`):
            -   Create `AuthStateChangeProvider.tsx` to manage global auth state change listener
            -   Provider should be added to root layout to ensure session synchronization across all pages

-   **Dependencies:**

    -   `@supabase/supabase-js` (already installed) - Provides `auth.onAuthStateChange()` method

-   **Data Flow:**

    ```
    Supabase Auth State Change
    (SIGNED_IN, SIGNED_OUT, TOKEN_REFRESHED, etc.)
        ↓
    onAuthStateChange Listener (Infrastructure)
        ↓
    AuthStateChangeProvider (Presentation)
        ↓
    useAuthStateChange Hook (Presentation)
        ↓
    Update Zustand Store (useAuthStore)
        ↓
    Invalidate React Query Cache
        ↓
    UI Components Auto-Update
    ```

    **Simplified Approach:**

    -   Supabase's `onAuthStateChange` already handles cross-tab synchronization via localStorage
    -   When token expires or is invalidated, Supabase triggers `SIGNED_OUT` event
    -   When token is refreshed, Supabase triggers `TOKEN_REFRESHED` event
    -   We listen to these events and update our stores/cache accordingly

-   **Supabase `onAuthStateChange` Implementation:**

    -   Supabase provides `auth.onAuthStateChange()` method that listens to authentication state changes
    -   Events include: `SIGNED_IN`, `SIGNED_OUT`, `TOKEN_REFRESHED`, `USER_UPDATED`, `PASSWORD_RECOVERY`
    -   **Supabase automatically handles cross-tab synchronization** via localStorage - when one tab changes, all tabs receive the event
    -   When token expires, Supabase triggers `SIGNED_OUT` event automatically
    -   When token is refreshed, Supabase triggers `TOKEN_REFRESHED` event automatically
    -   Listener must be properly cleaned up to prevent memory leaks
    -   Listener should update Zustand store and invalidate React Query cache on state changes

    ```typescript
    // Example implementation in authRepositorySupabase.ts
    onAuthStateChange: (callback: (event: SessionChangeEvent) => void) => {
        const {
            data: { subscription },
        } = supabaseClient.auth.onAuthStateChange((event, session) => {
            callback({
                event,
                session: session ? mapSupabaseSessionToDomain(session) : null,
            });
        });

        // Return cleanup function
        return () => {
            subscription.unsubscribe();
        };
    };
    ```

-   **Simplified Session Management:**

    -   **Keep it simple**: As long as Supabase considers the token active, maintain the session
    -   When Supabase detects token expiration or invalidation, it triggers `SIGNED_OUT` event
    -   We listen to this event and automatically sign out the user
    -   No need for manual session tracking or multi-session detection
    -   Supabase handles all session validation automatically

-   **Error Handling:**

    -   Handle cases where `onAuthStateChange` fails to subscribe
    -   Handle cases where event listener cleanup fails
    -   Gracefully handle Supabase connection errors

-   **Performance Considerations:**

    -   `onAuthStateChange` listener should be set up once at app initialization
    -   Listener is lightweight and does not impact performance
    -   Clean up event listeners properly to prevent memory leaks

-   **Security Considerations:**

    -   All session validation is handled by Supabase (trusted source)
    -   When Supabase invalidates a token, we automatically sign out (no manual checks needed)
    -   Cross-tab synchronization via Supabase is secure (uses Supabase's localStorage keys)

-   **Testing:**

    -   Test session persistence across browser tabs
    -   Test session synchronization when signing out in one tab
    -   Test automatic sign-out when token expires (mock Supabase event)
    -   Test automatic session update when token is refreshed
    -   Test cleanup of event listeners
    -   Test error handling for subscription failures

---

**Definition of Done:**

-   [ ] `onAuthStateChange` listener implemented in `authRepositorySupabase.ts`
-   [ ] `AuthStateChangeProvider` created and integrated in root layout
-   [ ] `useAuthStateChange` hook created for subscribing to auth state changes
-   [ ] Hook updates Zustand store (`useAuthStore`) on SIGNED_IN/SIGNED_OUT/TOKEN_REFRESHED events
-   [ ] Hook invalidates React Query cache on SIGNED_IN/SIGNED_OUT events
-   [ ] Sign out in one tab invalidates session in all tabs (via Supabase event)
-   [ ] Token expiration automatically signs out user across all tabs (via Supabase event)
-   [ ] Token refresh automatically updates session across all tabs (via Supabase event)
-   [ ] All event listeners properly cleaned up (no memory leaks)
-   [ ] Error handling implemented for subscription failures
-   [ ] Unit tests written for usecases (subscribeToAuthChanges)
-   [ ] Integration tests for cross-tab synchronization
-   [ ] Code reviewed and approved
-   [ ] Documentation updated with session management patterns

---

**Related Components:**

-   **Files to create:**

    -   `core/domain/auth.ts` - Add `SessionChangeEvent` type
    -   `core/usecases/auth.ts` - Add `subscribeToAuthChanges` usecase
    -   `presentation/hooks/useAuthStateChange.ts` - Hook for subscribing to auth state changes
    -   `presentation/providers/AuthStateChangeProvider.tsx` - Provider for managing auth state changes

-   **Files to modify:**

    -   `core/ports/authRepository.ts` - Add `onAuthStateChange` method to interface
    -   `infrastructure/supabase/authRepositorySupabase.ts` - Implement `onAuthStateChange` method
    -   `app/layout.tsx` - Add `AuthStateChangeProvider` to root layout

-   **Implementation notes:**

    -   `onAuthStateChange` listener should be set up in `AuthStateChangeProvider` at app initialization
    -   Supabase automatically handles cross-tab synchronization via localStorage
    -   When `SIGNED_OUT` event is received, clear Zustand store and invalidate React Query cache
    -   When `SIGNED_IN` or `TOKEN_REFRESHED` event is received, update Zustand store and invalidate React Query cache
    -   Follow Clean Architecture: hooks call usecases, not repositories directly
    -   All code should be properly typed with TypeScript (no `any` types)

-   **SessionChangeEvent Type:**

    ```typescript
    type SessionChangeEvent = {
        event: "SIGNED_IN" | "SIGNED_OUT" | "TOKEN_REFRESHED" | "USER_UPDATED" | "PASSWORD_RECOVERY";
        session: Session | null;
    };
    ```

-   **AuthStateChangeProvider Example:**

    ```typescript
    const AuthStateChangeProvider = ({ children }: Props) => {
        const { data: session } = useSession();
        const setSession = useAuthStore((state) => state.setSession);
        const setUser = useAuthStore((state) => state.setUser);
        const clearAuth = useAuthStore((state) => state.clearAuth);
        const queryClient = useQueryClient();

        useEffect(() => {
            const unsubscribe = subscribeToAuthChanges(authRepositorySupabase, (event) => {
                if (event.event === "SIGNED_OUT" || !event.session) {
                    // Clear auth state
                    clearAuth();
                    queryClient.invalidateQueries({ queryKey: queryKeys.auth.session() });
                    queryClient.invalidateQueries({ queryKey: queryKeys.auth.user() });
                } else if (event.session) {
                    // Update auth state
                    setSession(event.session);
                    setUser(event.session.user);
                    queryClient.invalidateQueries({ queryKey: queryKeys.auth.session() });
                    queryClient.invalidateQueries({ queryKey: queryKeys.auth.user() });
                }
            });

            return () => {
                unsubscribe();
            };
        }, [setSession, setUser, clearAuth, queryClient]);

        return <>{children}</>;
    };
    ```

---

**Dependencies:**

-   This ticket builds on the existing authentication implementation (tickets 1, 2, 3)
-   Requires Supabase authentication to be fully configured
-   Relies on Supabase's built-in session management and token validation

---

**Performance Considerations:**

-   `onAuthStateChange` listener is lightweight and does not impact performance
-   Listener is set up once at app initialization, not on every render
-   Supabase handles all cross-tab synchronization efficiently via localStorage

---

**Security Considerations:**

-   All session validation is handled by Supabase (trusted source)
-   When Supabase invalidates a token, we automatically sign out (no manual validation needed)
-   Cross-tab synchronization via Supabase is secure (uses Supabase's localStorage keys)
-   All session operations go through Clean Architecture layers (security enforced at infrastructure level)

---

**Accessibility Considerations:**

-   No new UI components requiring accessibility compliance
-   Existing auth flows remain accessible

---

**Browser Compatibility:**

-   Supabase handles browser compatibility internally
-   `onAuthStateChange` works in all modern browsers where Supabase is supported
-   Cross-tab synchronization handled by Supabase via localStorage (supported in all modern browsers)
