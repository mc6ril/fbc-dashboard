---
Generated: 2025-01-27 21:00:00
Ticket Number: 32
---

# FBC-32: Create Revenus page - MVP with basic revenue table

## Type

Feature

## Priority

High

## Story Points

8

## Labels

`feature`, `revenue`, `financial`, `dashboard`, `domain`, `usecases`, `presentation`

## Git Branch

`feat/fbc-32-revenus-page-mvp`

## Description

Create a new "Revenus" page (`/dashboard/revenus`) that displays a detailed financial table showing revenue, costs, and profit for a selected period. This MVP includes:

- Basic revenue calculation (CA from SALE activities)
- Material costs calculation (unitCost * quantity sold)
- Gross margin calculation and display
- Period selector (month/quarter/year/custom) with default to current month
- Simple table layout (non-expandable rows for MVP)

This is the foundation for the revenue tracking feature. Advanced features like expandable rows, product breakdown, and comparison will be added in subsequent tickets.

## User Story

As a business owner, I want to see a detailed financial breakdown of my revenue, costs, and profit for a selected period so that I can understand my business performance and make informed decisions.

## Acceptance Criteria

1. **New route and navigation**:
   - Create `/dashboard/revenus` route with new page
   - Add "Revenus" to navigation in `DashboardNavbar.tsx`
   - Add translation key `revenues` to `fr.json`
   - Page displays correctly in navigation

2. **Period selector component**:
   - Create `PeriodSelector` component with options: Month, Quarter, Year, Custom
   - Default selection: Current month
   - Custom option allows date range selection (start date + end date)
   - Period selector updates table data when changed

3. **Revenue calculation usecases**:
   - Create `computeRevenue` usecase in `core/usecases/revenue.ts`
   - Calculate total revenue from SALE activities for period
   - Calculate material costs (sum of `unitCost * abs(quantity)` for all sales)
   - Calculate gross margin (revenue - material costs)
   - Calculate gross margin rate (gross margin / revenue * 100)
   - Support date range filtering (startDate, endDate)

4. **Revenue domain types**:
   - Create `RevenueData` type in `core/domain/revenue.ts`
   - Include: period, startDate, endDate, totalRevenue, costs (material), grossMargin, grossMarginRate
   - Add JSDoc documentation for business meaning

5. **Revenue table display**:
   - Create `RevenueTable` component displaying:
     - Revenue section: Total CA
     - Costs section: Material costs
     - Gross margin section: Gross margin amount and rate
   - Table uses proper formatting (currency, percentages)
   - Table is accessible (proper ARIA labels, semantic HTML)

6. **React Query hooks**:
   - Create `useRevenue` hook in `presentation/hooks/useRevenue.ts`
   - Hook accepts startDate and endDate parameters
   - Hook calls `computeRevenue` usecase
   - Hook provides `data`, `isLoading`, `error` states

7. **Repository methods** (if needed):
   - Verify existing `ActivityRepository` and `ProductRepository` methods support date filtering
   - Add date filtering to repository methods if missing

## Technical Considerations

### Architecture Layers Impacted

-   **Domain Layer** (`core/domain/revenue.ts`):
    -   Create `RevenueData` type with all required fields
    -   Create `RevenuePeriod` type for period selection
    -   Add JSDoc documentation

-   **Usecases Layer** (`core/usecases/revenue.ts`):
    -   Create `computeRevenue` function
    -   Accept `ActivityRepository` and `ProductRepository` as parameters
    -   Filter activities by date range
    -   Calculate revenue from SALE activities (sum of `amount`)
    -   Calculate material costs (sum of `unitCost * abs(quantity)` for sales)
    -   Calculate gross margin and rate
    -   Return `RevenueData` object

-   **Infrastructure Layer** (`infrastructure/supabase/`):
    -   Verify `activityRepositorySupabase` supports date filtering in `list()` method
    -   Add date filtering if needed (startDate, endDate parameters)

-   **Presentation Layer** (`presentation/hooks/useRevenue.ts`):
    -   Create `useRevenue` hook
    -   Use React Query with stable queryKey
    -   Call `computeRevenue` usecase

-   **Presentation Layer** (`presentation/components/revenueTable/`):
    -   Create `RevenueTable` component
    -   Create `PeriodSelector` component
    -   Use SCSS modules with variables from `styles/variables/*`
    -   Implement accessibility (ARIA labels, semantic HTML)

-   **Presentation Layer** (`app/dashboard/revenus/`):
    -   Create `page.tsx` with period selector and revenue table
    -   Use `useRevenue` hook
    -   Handle loading and error states

### Date Range Handling

-   Use ISO 8601 format for dates
-   Default to current month: first day of month 00:00:00 to last day 23:59:59
-   Custom range: user selects start and end dates
-   Validate date ranges (startDate <= endDate)

### Currency and Number Formatting

-   Use proper currency formatting (â‚¬ symbol, 2 decimal places)
-   Use percentage formatting for margins (1 decimal place)
-   Handle null/zero values gracefully

## Definition of Done

-   [ ] Domain types created in `core/domain/revenue.ts` with JSDoc
-   [ ] `computeRevenue` usecase created and tested
-   [ ] `useRevenue` hook created and working
-   [ ] `PeriodSelector` component created with all period options
-   [ ] `RevenueTable` component displays revenue, costs, and gross margin
-   [ ] Period selector defaults to current month
-   [ ] Custom date range selection works correctly
-   [ ] All calculations are accurate (revenue, costs, margin)
-   [ ] Currency and percentage formatting applied correctly
-   [ ] New route `/dashboard/revenus` created and accessible
-   [ ] Navigation updated with "Revenus" tab
-   [ ] Translations added to `fr.json`
-   [ ] Component is accessible (ARIA labels, semantic HTML)
-   [ ] SCSS uses variables from `styles/variables/*`
-   [ ] All existing tests pass
-   [ ] New tests added for `computeRevenue` usecase
-   [ ] No linter errors

## Related Components

### Files to Create

-   `src/core/domain/revenue.ts`
-   `src/core/usecases/revenue.ts`
-   `src/presentation/hooks/useRevenue.ts`
-   `src/presentation/components/revenueTable/RevenueTable.tsx`
-   `src/presentation/components/revenueTable/RevenueTable.module.scss`
-   `src/presentation/components/revenueTable/PeriodSelector.tsx`
-   `src/presentation/components/revenueTable/PeriodSelector.module.scss`
-   `src/app/dashboard/revenus/page.tsx`
-   `src/app/dashboard/revenus/page.module.scss`

### Files to Modify

-   `src/presentation/components/dashboardNavbar/DashboardNavbar.tsx`
-   `src/shared/i18n/messages/fr.json`

### Files to Test

-   `__tests__/core/usecases/revenue.test.ts`
-   `__tests__/core/domain/revenue.test.ts` (if validation functions added)

## Dependencies

-   Requires FBC-31 (navigation reorganization) to be completed first
-   Requires existing `ActivityRepository` and `ProductRepository` interfaces
-   Requires existing activity and product domain types

## Notes

-   This is the MVP version - expandable rows and product breakdown will be added in FBC-33
-   Shipping costs and indirect costs will be added in FBC-33
-   Comparison with previous period will be added in FBC-34 (but structure should be prepared)
-   Default period is current month as specified
-   Material costs are calculated from actual sales (unitCost * quantity sold), not from product definitions

