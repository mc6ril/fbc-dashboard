---
Generated: 2025-01-27 16:00:00
Ticket Number: 2
---

## Jira Ticket

**Title:** Install Supabase with authentication system and database connection

**Type:** Feature

**Priority:** High

**Story Points:** 5

**Labels:** infrastructure, authentication, database, security, supabase

**Git Branch:** `feat/fbc-2-install-supabase-auth-db`

**Branch Creation:**

```bash
git checkout -b feat/fbc-2-install-supabase-auth-db
```

---

**Description:**

The project currently has the Supabase JavaScript client package (`@supabase/supabase-js`) installed in dependencies, but there is no Supabase client configuration, authentication system, or database connection setup. To enable backend functionality, we need to:

1. Configure Supabase client in the Infrastructure layer following Clean Architecture principles
2. Set up environment variables for secure credential management (Project URL and API Key)
3. Implement authentication system with proper session management
4. Establish database connection infrastructure
5. Create authentication domain types and usecases
6. Set up authentication hooks for React Query integration

This implementation will provide the foundation for all future database operations and user authentication, ensuring secure access to Supabase services while maintaining strict layer separation according to Clean Architecture principles.

**Security Considerations:**

-   Project URL and API Key are sensitive data and must be stored in environment variables
-   Environment variables must use `NEXT_PUBLIC_` prefix for client-side access in Next.js
-   `.env.local` file must never be committed to git (already in `.gitignore`)
-   All Supabase operations must go through Infrastructure layer, never directly from UI
-   Authentication tokens must be handled securely with proper session management

**User Story:**

As a developer
I want Supabase installed and configured with authentication and database connection
So that I can securely access Supabase services (authentication, database queries) through Clean Architecture layers

---

**Acceptance Criteria:**

-   [ ] AC1: Environment variables file `.env.local` created with `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` (user will provide values)
-   [ ] AC2: Environment variables are properly validated and throw errors if missing
-   [ ] AC3: Supabase client is created in `infrastructure/supabase/client.ts` following Clean Architecture
-   [ ] AC4: Supabase client is a singleton instance exported for use in repository implementations
-   [ ] AC5: Authentication domain types are created in `core/domain/auth.ts` (User, Session, AuthError types)
-   [ ] AC6: Authentication port interface is created in `core/ports/authRepository.ts` with methods: `signIn()`, `signUp()`, `signOut()`, `getSession()`, `getUser()`
-   [ ] AC7: Authentication repository implementation is created in `infrastructure/supabase/authRepositorySupabase.ts` implementing the port interface
-   [ ] AC8: Authentication usecases are created in `core/usecases/auth.ts`: `signInUser()`, `signUpUser()`, `signOutUser()`, `getCurrentSession()`, `getCurrentUser()`
-   [ ] AC9: Authentication React Query hooks are created in `presentation/hooks/useAuth.ts` for: `useSignIn()`, `useSignUp()`, `useSignOut()`, `useSession()`, `useUser()`
-   [ ] AC10: Authentication state management is set up in `presentation/stores/useAuthStore.ts` using Zustand for UI state (session, user, loading states)
-   [ ] AC11: All authentication operations go through the proper flow: UI → Hook → Usecase → Repository → Supabase
-   [ ] AC12: Error handling is implemented for all authentication operations with proper error types
-   [ ] AC13: TypeScript types are properly defined for all authentication-related code (no `any` types)
-   [ ] AC14: `.env.local.example` file is created with placeholder values (without actual secrets) for documentation
-   [ ] AC15: README.md is updated with instructions for setting up environment variables

---

**Technical Considerations:**

-   **Architecture Layers Impacted:**

    -   **Domain** (`core/domain/`):

        -   Create `auth.ts` with User, Session, AuthError types
        -   Pure TypeScript types, no external dependencies

    -   **Ports** (`core/ports/`):

        -   Create `authRepository.ts` interface with authentication methods
        -   Define contract for authentication operations

    -   **Usecases** (`core/usecases/`):

        -   Create `auth.ts` with authentication usecases
        -   Pure functions that orchestrate authentication logic
        -   Take `AuthRepository` as parameter

    -   **Infrastructure** (`infrastructure/supabase/`):

        -   Create `client.ts` - Supabase client singleton
        -   Create `authRepositorySupabase.ts` - Authentication repository implementation
        -   Only layer that imports `@supabase/supabase-js`

    -   **Presentation** (`presentation/`):
        -   Create `hooks/useAuth.ts` - React Query hooks for authentication
        -   Create `stores/useAuthStore.ts` - Zustand store for UI state (session, user, loading)
        -   No direct Supabase calls, only through hooks → usecases → repositories

-   **Dependencies:**

    -   `@supabase/supabase-js` (already installed: ^2.81.1)
    -   `@tanstack/react-query` (already installed: ^5.90.9)
    -   `zustand` (already installed: ^5.0.8)
    -   Next.js environment variable support

-   **Data Flow:**

    ```
    UI Component
        ↓ calls
    React Query Hook (useSignIn, useSignUp, etc.)
        ↓ calls
    Usecase (signInUser, signUpUser, etc.)
        ↓ calls
    Repository (authRepositorySupabase)
        ↓ calls
    Supabase Client (infrastructure/supabase/client.ts)
        ↓ calls
    Supabase API
    ```

-   **Environment Variables:**

    -   Create `.env.local` file (user will provide values):
        ```bash
        NEXT_PUBLIC_SUPABASE_URL=<project_url>
        NEXT_PUBLIC_SUPABASE_ANON_KEY=<api_key>
        ```
    -   Create `.env.local.example` with placeholders:
        ```bash
        NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
        NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
        ```
    -   Validate environment variables at runtime with clear error messages
    -   Use `process.env.NEXT_PUBLIC_SUPABASE_URL` and `process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY`

-   **Security:**

    -   Never hardcode Project URL or API Key in source code
    -   Always use environment variables for sensitive data
    -   `.env.local` is already in `.gitignore` (verified)
    -   Use `NEXT_PUBLIC_` prefix for client-side environment variables in Next.js
    -   Validate environment variables on client initialization
    -   Handle authentication errors securely without exposing sensitive information

-   **Supabase Client Setup:**

    -   Create singleton client in `infrastructure/supabase/client.ts`
    -   Validate environment variables before creating client
    -   Export client instance for use in repository implementations
    -   Configure client with proper options (auth persistence, etc.)

-   **Authentication Implementation:**

    -   Support email/password authentication (can be extended later)
    -   Session management with automatic token refresh
    -   User state management in Zustand store
    -   React Query hooks for async authentication operations
    -   Proper error handling and user feedback

-   **Testing:**

    -   Unit tests for authentication usecases (mock repository)
    -   Unit tests for authentication domain types and validation
    -   Manual testing of authentication flow (sign in, sign up, sign out)
    -   Verify environment variable validation
    -   Test error handling for missing/invalid credentials

---

**Definition of Done:**

-   [] `.env.local` file created with environment variables (user provides values)
-   [] `.env.local.example` file created with placeholder values
-   [ ] Supabase client created in `infrastructure/supabase/client.ts` with environment variable validation
-   [ ] Authentication domain types created in `core/domain/auth.ts`
-   [ ] Authentication port interface created in `core/ports/authRepository.ts`
-   [ ] Authentication repository implementation created in `infrastructure/supabase/authRepositorySupabase.ts`
-   [ ] Authentication usecases created in `core/usecases/auth.ts`
-   [ ] Authentication React Query hooks created in `presentation/hooks/useAuth.ts`
-   [ ] Authentication Zustand store created in `presentation/stores/useAuthStore.ts`
-   [ ] All code follows Clean Architecture principles (no direct Supabase calls from UI)
-   [ ] All TypeScript types are properly defined (no `any` types)
-   [ ] Error handling implemented for all authentication operations
-   [ ] Environment variables validated with clear error messages
-   [ ] README.md updated with environment variable setup instructions
-   [ ] Unit tests written for authentication usecases (in `__tests__/core/usecases/auth.test.ts`)
-   [ ] Manual testing completed (sign in, sign up, sign out flows)
-   [ ] Code reviewed and approved
-   [ ] No security vulnerabilities (no hardcoded credentials, proper environment variable usage)

---

**Related Components:**

-   **Files to create:**

    -   `infrastructure/supabase/client.ts` - Supabase client singleton
    -   `infrastructure/supabase/authRepositorySupabase.ts` - Authentication repository implementation
    -   `core/domain/auth.ts` - Authentication domain types (User, Session, AuthError)
    -   `core/ports/authRepository.ts` - Authentication repository interface
    -   `core/usecases/auth.ts` - Authentication usecases
    -   `presentation/hooks/useAuth.ts` - Authentication React Query hooks
    -   `presentation/stores/useAuthStore.ts` - Authentication Zustand store
    -   `.env.local` - Environment variables (user provides values)
    -   `.env.local.example` - Example environment variables file

-   **Files to modify:**

    -   `README.md` - Add environment variable setup instructions

-   **Test files to create:**

    -   `__tests__/core/usecases/auth.test.ts` - Authentication usecase tests

-   **Implementation notes:**

    -   Supabase client must be a singleton to avoid multiple instances
    -   Environment variables must be validated on client creation
    -   All authentication operations must follow Clean Architecture flow
    -   Zustand store should only contain UI state (session, user, loading), not business logic
    -   React Query hooks should handle async operations and caching
    -   Error types should be defined in domain layer
    -   Use TypeScript strict mode (no `any` types)
    -   Follow project code conventions (arrow functions, type for props, etc.)

-   **Security checklist:**

    -   [ ] No hardcoded credentials in source code
    -   [ ] Environment variables used for all sensitive data
    -   [ ] `.env.local` in `.gitignore` (already verified)
    -   [ ] Environment variables validated on initialization
    -   [ ] Error messages don't expose sensitive information
    -   [ ] Authentication tokens handled securely

---

**User Instructions:**

1. **Provide Supabase Credentials:**

    - Project URL (e.g., `https://xxxxx.supabase.co`)
    - API Key (anon/public key)

2. **Create `.env.local` file:**

    ```bash
    NEXT_PUBLIC_SUPABASE_URL=<your_project_url>
    NEXT_PUBLIC_SUPABASE_ANON_KEY=<your_api_key>
    ```

3. **Verify Setup:**
    - Run `yarn dev` to start development server
    - Check browser console for any Supabase connection errors
    - Verify environment variables are loaded correctly

---

**Dependencies:**

-   This ticket is a foundation for all future database and authentication features
-   Future tickets will depend on this infrastructure setup
-   All repository implementations will use the Supabase client from this ticket
